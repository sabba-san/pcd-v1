<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Projects - LIDAR Defect Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='shared/css/main.css') }}">
</head>

<body>
  {% set total_projects = projects|length %}
  {% set total_defects = projects|sum(attribute='defect_count') %}
  <main class="bento-grid">
    <section class="bento-card span-2">
      <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.65rem; gap: 0.75rem; flex-wrap: wrap;">
        <a href="{{ url_for('module3.dashboard') }}"
          style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
          <span class="eyebrow"><i class="fas fa-bolt"></i> DLP Advisor</span>
        </a>
        <div class="chip-row">
          <span class="chip"><i class="fas fa-folder-open"></i> {{ total_projects }} projects</span>
          <span class="chip"><i class="fas fa-exclamation-triangle"></i> {{ total_defects }} defects</span>
        </div>
        <a href="{{ url_for('module3.dashboard') }}" class="btn-back-dashboard"
          style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); text-decoration: none; margin-left: auto; font-size: 0.9rem;">
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <button id="themeToggle" class="theme-toggle" type="button">
          <i class="fas fa-moon"></i>
          <span>Dark</span>
        </button>
      </div>
      <h1><i class="fas fa-folder-open"></i> Projects</h1>
      <p class="subtitle">Select a project to view and manage defects in the 3D visualization viewer.</p>
      <div class="action-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search projects..." onkeyup="filterProjects()">
        </div>
        <div class="filter-group">
          <label class="filter-label" for="dateFilter">Date range</label>
          <select id="dateFilter" class="filter-select" onchange="filterProjects()">
            <option value="all">All time</option>
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="sortOrder">Sort</label>
          <select id="sortOrder" class="filter-select" onchange="filterProjects()">
            <option value="newest">Newest to oldest</option>
            <option value="oldest">Oldest to newest</option>
          </select>
        </div>
        <a href="/upload-data" class="btn"><i class="fas fa-plus"></i> New Project</a>
      </div>
    </section>

    {% if projects %}
    <section class="bento-card span-2">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h2 style="margin: 0; color: var(--ink);">Project List</h2>
        <span class="chip" style="color: var(--muted); background: rgba(255,255,255,0.05);">{{ total_projects }}
          items</span>
      </div>
      <div class="projects-grid" id="projectsGrid">
        {% for project in projects %}
        <a href="/scans/{{ project.id }}/visualize" class="project-card" data-name="{{ project.name|lower }}"
          data-date="{{ project.created_at.isoformat() if project.created_at else '' }}">
          <div class="project-header">
            <h3 class="project-title">
              <i class="fas fa-cube"></i>
              {{ project.name }}
            </h3>
            <span class="project-id">#{{ project.id }}</span>
          </div>

          <div class="project-meta">
            {% if project.metadata %}
            <div class="meta-item">
              <div class="meta-label">Scan Date</div>
              <div class="meta-value">{{ project.metadata.scan_date or 'N/A' }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Unit</div>
              <div class="meta-value">{{ project.metadata.unit_no or 'N/A' }}</div>
            </div>
            {% if project.metadata.address %}
            <div class="meta-item" style="grid-column: span 2;">
              <div class="meta-label">Address</div>
              <div class="meta-value" style="font-size: 0.85rem;">{{ project.metadata.address }}</div>
            </div>
            {% endif %}
            {% else %}
            <div class="meta-item">
              <div class="meta-label">Created</div>
              <div class="meta-value">{{ project.created_at.strftime('%Y-%m-%d') }}</div>
            </div>
            {% endif %}
          </div>

          <div class="project-stats">
            <div class="stat">
              <i class="fas fa-exclamation-triangle"></i>
              <span class="stat-value">{{ project.defect_count }}</span> defects
            </div>
            {% if project.model_path %}
            <div class="stat">
              <i class="fas fa-cube"></i>
              <span>3D Model</span>
            </div>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </div>
    </section>
    {% else %}
    <section class="bento-card span-2 empty-state">
      <i class="fas fa-folder-open"></i>
      <h3>No Projects Yet</h3>
      <p>Upload your first scan to get started with defect detection and visualization.</p>
      <a href="/upload-data" class="btn">
        <i class="fas fa-upload"></i> Upload First Scan
      </a>
    </section>
    {% endif %}
  </main>

  <script>
    function applyTheme(theme) {
      const body = document.body;
      const toggle = document.getElementById('themeToggle');
      const icon = toggle.querySelector('i');
      const label = toggle.querySelector('span');

      if (theme === 'light') {
        body.classList.add('light-mode');
        icon.className = 'fas fa-sun';
        label.textContent = 'Light';
      } else {
        body.classList.remove('light-mode');
        icon.className = 'fas fa-moon';
        label.textContent = 'Dark';
        theme = 'dark';
      }

      localStorage.setItem('projects-theme', theme);
    }

    function toggleTheme() {
      const current = localStorage.getItem('projects-theme') || 'dark';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    }

    document.addEventListener('DOMContentLoaded', () => {
      applyTheme(localStorage.getItem('projects-theme') || 'dark');
      const toggle = document.getElementById('themeToggle');
      if (toggle) {
        toggle.addEventListener('click', toggleTheme);
      }
    });

    function filterProjects() {
      const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
      const dateRange = document.getElementById('dateFilter')?.value || 'all';
      const sortOrder = document.getElementById('sortOrder')?.value || 'newest';
      const grid = document.getElementById('projectsGrid');
      const cards = Array.from(document.querySelectorAll('.project-card'));

      const now = new Date();
      const rangeDays = dateRange === 'all' ? null : parseInt(dateRange, 10);

      const filtered = cards.filter(card => {
        const name = card.getAttribute('data-name') || '';
        if (!name.includes(searchTerm)) return false;

        if (!rangeDays) return true;

        const dateStr = card.getAttribute('data-date');
        const projectDate = dateStr ? new Date(dateStr) : null;
        if (!projectDate || isNaN(projectDate)) return true;

        const diffDays = (now - projectDate) / (1000 * 60 * 60 * 24);
        return diffDays <= rangeDays;
      });

      const timeValue = card => {
        const dateStr = card.getAttribute('data-date');
        const dt = dateStr ? new Date(dateStr) : null;
        return dt && !isNaN(dt) ? dt.getTime() : 0;
      };

      filtered.sort((a, b) => {
        const diff = timeValue(b) - timeValue(a);
        return sortOrder === 'oldest' ? -diff : diff;
      });

      cards.forEach(card => { card.style.display = 'none'; });
      filtered.forEach(card => { card.style.display = 'block'; grid.appendChild(card); });
    }
  </script>
</body>

</html>