<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualization - Lidar Defect Viewer </title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background: #f3f4f6;
            color: #1e293b;
            overflow: hidden;
            height: 100vh;
        }

        .card {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
            background: #fff;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
        }

        /* Light Mode */
        body.light-mode {
            background: #f8fafc;
            color: #1e293b;
        }

        body.light-mode .navbar {
            background: #ffffff;
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .nav-brand {
            color: #3b82f6;
        }

        body.light-mode .nav-link {
            color: #64748b;
        }

        body.light-mode .nav-link:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        body.light-mode .nav-link.active {
            background: #3b82f6;
            color: #fff;
        }

        body.light-mode .project-banner {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .project-info-label {
            color: #64748b;
        }

        body.light-mode .project-info-value {
            color: #1e293b;
        }

        body.light-mode .project-info-value.highlight {
            color: #3b82f6;
        }

        body.light-mode .viewer-container {
            background: #e2e8f0;
        }

        body.light-mode .toolbar-group {
            background: rgba(255, 255, 255, 0.95);
            border-color: #cbd5e1;
        }

        body.light-mode .toolbar-group-label {
            color: #64748b;
        }

        body.light-mode .toolbar-btn {
            color: #475569;
        }

        body.light-mode .toolbar-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        body.light-mode .toolbar-btn.active {
            background: #3b82f6;
            color: #fff;
        }

        body.light-mode .view-presets {
            background: rgba(255, 255, 255, 0.95);
            border-color: #cbd5e1;
        }

        body.light-mode .model-stats {
            background: rgba(255, 255, 255, 0.95);
            border-color: #cbd5e1;
            color: #64748b;
        }

        body.light-mode .stat-value {
            color: #1e293b;
        }

        body.light-mode .camera-info {
            background: rgba(255, 255, 255, 0.95);
            border-color: #cbd5e1;
            color: #64748b;
        }

        body.light-mode .sidebar {
            background: #ffffff;
            border-left-color: #e2e8f0;
        }

        body.light-mode .sidebar-header {
            border-bottom-color: #e2e8f0;
        }

        body.light-mode .search-box input {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #1e293b;
        }

        body.light-mode .search-box input::placeholder {
            color: #94a3b8;
        }

        body.light-mode .search-box i {
            color: #94a3b8;
        }

        body.light-mode .filter-select {
            background: #f8fafc;
            border-color: #e2e8f0;
            color: #1e293b;
        }

        body.light-mode .defect-list::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        body.light-mode .defect-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
        }

        body.light-mode .defect-card {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        body.light-mode .defect-card:hover {
            border-color: #cbd5e1;
        }

        body.light-mode .defect-card.expanded,
        body.light-mode .defect-card.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        body.light-mode .defect-title {
            color: #1e293b;
        }

        body.light-mode .defect-description {
            color: #64748b;
        }

        body.light-mode .defect-coords {
            color: #94a3b8;
        }

        body.light-mode .defect-expanded {
            border-top-color: #e2e8f0;
        }

        body.light-mode .defect-meta-label {
            color: #94a3b8;
        }

        body.light-mode .defect-meta-value {
            color: #1e293b;
        }

        body.light-mode .defect-notes {
            background: #f1f5f9;
            color: #64748b;
        }

        body.light-mode .sidebar-footer {
            background: #f8fafc;
            border-top-color: #e2e8f0;
        }

        body.light-mode .empty-state {
            color: #94a3b8;
        }

        body.light-mode .empty-state h3 {
            color: #64748b;
        }

        body.light-mode .btn-outline {
            border-color: #cbd5e1;
            color: #64748b;
        }

        body.light-mode .btn-outline:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        body.light-mode .btn-secondary {
            background: #e2e8f0;
            color: #1e293b;
        }

        body.light-mode .btn-secondary:hover {
            background: #cbd5e1;
        }

        /* Navigation Bar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #0f172a;
            border-bottom: 1px solid #1e293b;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
            color: #60a5fa;
            text-decoration: none;
        }

        .nav-brand i {
            font-size: 20px;
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 14px;
            border-radius: 6px;
            color: #94a3b8;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-link:hover {
            background: #334155;
            color: #fff;
        }

        .nav-link.active {
            background: #3b82f6;
            color: #fff;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Project Info Banner */
        .project-banner {
            background: #0f172a;
            border: 1px solid #1e293b;
            padding: 12px 16px;
            border-radius: 0;
            margin: 0;
            flex-shrink: 0;
        }

        .project-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .project-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .project-info-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .project-info-value {
            font-size: 14px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .project-info-value.highlight {
            color: #60a5fa;
            font-size: 16px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #374151;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
        }

        .btn-outline:hover {
            background: #334155;
            color: #fff;
            border-color: #64748b;
        }

        .btn-icon {
            padding: 8px 10px;
            min-width: 36px;
            justify-content: center;
        }

        .btn-success {
            background: #22c55e;
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Main Layout - Full Page */
        .main-container {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* 3D Viewer */
        .viewer-container {
            flex: 1;
            position: relative;
            background: #0a0f1a;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Viewer Toolbar */
        .viewer-toolbar {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 8px;
            padding: 6px;
            border: 1px solid #334155;
        }

        .toolbar-group-label {
            font-size: 9px;
            text-transform: uppercase;
            color: #64748b;
            padding: 4px 8px;
            font-weight: 600;
        }

        .toolbar-btn {
            padding: 10px 12px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .toolbar-btn:hover {
            background: #334155;
            color: #fff;
        }

        .toolbar-btn.active {
            background: #3b82f6;
            color: #fff;
        }

        /* View Presets */
        .view-presets {
            position: absolute;
            top: 16px;
            right: 340px;
            display: flex;
            gap: 6px;
            background: rgba(30, 41, 59, 0.95);
            border-radius: 8px;
            padding: 6px;
            border: 1px solid #334155;
        }

        /* Model Stats */
        .model-stats {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: rgba(30, 41, 59, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            color: #94a3b8;
            border: 1px solid #334155;
        }

        .model-stats-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 4px;
        }

        .model-stats-row:last-child {
            margin-bottom: 0;
        }

        .stat-label {
            color: #64748b;
        }

        .stat-value {
            color: #e2e8f0;
            font-weight: 500;
        }

        /* Camera Info */
        .camera-info {
            position: absolute;
            bottom: 16px;
            right: 340px;
            background: rgba(30, 41, 59, 0.95);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 11px;
            color: #94a3b8;
            border: 1px solid #334155;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: #1e293b;
            border-left: 1px solid #334155;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 100;
            height: 100%;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #334155;
        }

        .sidebar-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .sidebar-title h2 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .defect-count {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 12px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 13px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .search-box input::placeholder {
            color: #64748b;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: 14px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 8px;
        }

        .filter-select {
            flex: 1;
            padding: 8px 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e5e7eb;
            font-size: 12px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* Defect List */
        .defect-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .defect-list::-webkit-scrollbar {
            width: 6px;
        }

        .defect-list::-webkit-scrollbar-track {
            background: #0f172a;
        }

        .defect-list::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        .defect-list::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .defect-card {
            background: #0f172a;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 8px;
            border: 1px solid #334155;
            transition: all 0.2s;
            cursor: pointer;
        }

        .defect-card:hover {
            border-color: #475569;
            transform: translateX(2px);
        }

        .defect-card.selected {
            border-color: #3b82f6;
            background: #1e3a5f;
        }

        .defect-card.expanded {
            border-color: #3b82f6;
            background: #1e3a5f;
        }

        .defect-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .defect-title {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .defect-index {
            color: #64748b;
            font-size: 12px;
            font-weight: normal;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-reported {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-review {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-fixed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .defect-description {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .defect-coords {
            font-size: 11px;
            color: #64748b;
            display: flex;
            gap: 12px;
        }

        .coord-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .coord-label {
            color: #475569;
        }

        .defect-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 4px;
        }

        /* Expandable defect details */
        .defect-expanded {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #334155;
        }

        .defect-card.expanded .defect-expanded {
            display: block;
        }

        .defect-thumbnail {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .defect-thumbnail:hover {
            opacity: 0.8;
        }

        .defect-meta-label {
            font-size: 10px;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .defect-meta-value {
            font-size: 13px;
            color: #e5e7eb;
            margin-bottom: 10px;
            word-break: break-word;
        }

        .defect-notes {
            font-size: 12px;
            color: #94a3b8;
            font-style: italic;
            background: #0f172a;
            padding: 8px;
            border-radius: 4px;
        }

        .no-image {
            color: #64748b;
            font-size: 12px;
            font-style: italic;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid #334155;
            background: #0f172a;
        }

        /* Modal - light/card style to match upload/process pages */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.35);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #ffffff;
            border-radius: 12px;
            width: 520px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            color: #64748b;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .modal-body {
            padding: 18px 20px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #1e293b;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.06);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            padding: 12px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .defect-image {
            width: 100%;
            max-height: 220px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .form-group input:readonly,
        .form-group textarea:readonly {
            background: #f1f5f9;
            color: #64748b;
            cursor: default;
        }

        .empty-state h3 {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <main class="card">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-left">
                <a href="{{ url_for('module3.dashboard') }}" class="nav-brand">
                    <i class="fas fa-cube"></i>
                    LIDAR Defect Viewer
                </a>
                <div class="nav-links">
                    <a href="{{ url_for('module3.dashboard') }}" class="nav-link"><i class="fas fa-folder-open"></i>
                        Projects</a>
                    <a href="{{ url_for('module3.visualize', project_id=scan_id) }}" class="nav-link active"><i
                            class="fas fa-eye"></i>
                        Visualize</a>
                </div>
            </div>
            <div class="nav-right">
                <button class="btn btn-outline btn-icon" id="themeToggle" onclick="toggleTheme()"
                    title="Toggle Light/Dark Mode">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <button class="btn btn-outline btn-icon" onclick="toggleDebugInspector()" title="Debug Inspector">
                    <i class="fas fa-bug"></i>
                </button>
            </div>
        </nav>

        <!-- Project Info Banner -->
        <div class="project-banner">
            <div class="project-info-grid">
                <div class="project-info-item">
                    <span class="project-info-label">Project Name</span>
                    <span class="project-info-value highlight">{{ upload_metadata.project_name if upload_metadata and
                        upload_metadata.project_name else scan.name or 'Untitled Project' }}</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Scan ID</span>
                    <span class="project-info-value">#{{ scan.id }} - {{ scan.name }}</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Address</span>
                    <span class="project-info-value">{{ upload_metadata.address if upload_metadata and
                        upload_metadata.address else 'Not specified' }}</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Unit No.</span>
                    <span class="project-info-value">{{ upload_metadata.unit_no if upload_metadata and
                        upload_metadata.unit_no else 'N/A' }}</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Scan Date</span>
                    <span class="project-info-value">{{ upload_metadata.scan_date if upload_metadata and
                        upload_metadata.scan_date else (scan.created_at.strftime('%Y-%m-%d') if scan.created_at else
                        'Unknown') }}</span>
                </div>
                <div class="project-info-item">
                    <span class="project-info-label">Model File</span>
                    <span class="project-info-value">{{ scan.model_path.split('/')[-1] if scan.model_path else 'No
                        model' }}</span>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- 3D Viewer -->
            <div class="viewer-container">
                <canvas id="renderCanvas"></canvas>

                <!-- Left Toolbar (Camera Controls) -->
                <div class="viewer-toolbar">
                    <div class="toolbar-group">
                        <span class="toolbar-group-label">Action</span>
                        <button class="toolbar-btn" id="addDefectBtn" onclick="toggleAddMode()" title="Add Defect"><i
                                class="fas fa-plus"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <span class="toolbar-group-label">Zoom</span>
                        <button class="toolbar-btn" onclick="zoomIn()" title="Zoom In"><i
                                class="fas fa-search-plus"></i></button>
                        <button class="toolbar-btn" onclick="zoomOut()" title="Zoom Out"><i
                                class="fas fa-search-minus"></i></button>
                        <button class="toolbar-btn" onclick="fitToView()" title="Fit to View"><i
                                class="fas fa-expand"></i></button>
                    </div>
                    <div class="toolbar-group">
                        <span class="toolbar-group-label">Display</span>
                        <button class="toolbar-btn" id="toggleDefectsBtn" onclick="toggleDefects()"
                            title="Toggle Defects"><i class="fas fa-map-marker-alt"></i></button>
                        <button class="toolbar-btn" id="xrayBtn" onclick="toggleXRay()" title="X-Ray Mode"><i
                                class="fas fa-x-ray"></i></button>
                        <button class="toolbar-btn" id="wireframeBtn" onclick="toggleWireframe()" title="Wireframe"><i
                                class="fas fa-border-all"></i></button>
                    </div>
                </div>

                <!-- View Presets -->
                <div class="view-presets">
                    <button class="toolbar-btn" onclick="resetView()" title="Reset View"><i
                            class="fas fa-sync"></i></button>
                    <button class="toolbar-btn" onclick="setTopView()" title="Top View"><i
                            class="fas fa-arrow-down"></i></button>
                    <button class="toolbar-btn" onclick="setFrontView()" title="Front View"><i
                            class="fas fa-arrow-right"></i></button>
                    <button class="toolbar-btn" onclick="set3DView()" title="3D View"><i
                            class="fas fa-cube"></i></button>
                </div>

                <!-- Model Stats -->
                <div class="model-stats" id="modelStats">
                    <div class="model-stats-row">
                        <span class="stat-label">Meshes:</span>
                        <span class="stat-value" id="meshCount">0</span>
                    </div>
                    <div class="model-stats-row">
                        <span class="stat-label">Defects:</span>
                        <span class="stat-value" id="defectStat">0</span>
                    </div>
                    <div class="model-stats-row">
                        <span class="stat-label">Model Size:</span>
                        <span class="stat-value" id="modelSize">-</span>
                    </div>
                </div>

                <!-- Camera Info -->
                <div class="camera-info" id="cameraInfo">
                    <i class="fas fa-video"></i> Camera: X:0.0 Y:0.0 Z:0.0
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <h2><i class="fas fa-exclamation-triangle"></i> Defects</h2>
                        <span class="defect-count" id="defectCount">0</span>
                    </div>

                    <!-- Search -->
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="defectSearch" placeholder="Search defects..." oninput="searchDefects()">
                    </div>

                    <!-- Filters -->
                    <div class="filters">
                        <select class="filter-select" id="statusFilter" onchange="filterDefects()">
                            <option value="">All Status</option>
                            <option value="Reported">Reported</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Fixed">Fixed</option>
                        </select>
                        <select class="filter-select" id="sortFilter" onchange="sortDefects()">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="status">By Status</option>
                        </select>
                    </div>
                </div>

                <!-- Defect List -->
                <div class="defect-list" id="defectList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Defect Detail Modal -->
        <div class="modal-overlay" id="defectModal">
            <div class="modal">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Edit Defect</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <img id="defectImage" class="defect-image" src="" alt="Defect Image" style="display: none;">
                    <div class="form-group">
                        <label>Element</label>
                        <input type="text" id="defectElement" readonly>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <select id="defectLocation">
                            <option value="">Not Specified</option>
                            <option value="Living Room">Living Room</option>
                            <option value="Kitchen">Kitchen</option>
                            <option value="Dining Room">Dining Room</option>
                            <option value="Master Bedroom">Master Bedroom</option>
                            <option value="Bedroom 1">Bedroom 1</option>
                            <option value="Bedroom 2">Bedroom 2</option>
                            <option value="Bedroom 3">Bedroom 3</option>
                            <option value="Bathroom">Bathroom</option>
                            <option value="Toilet">Toilet</option>
                            <option value="Master Bathroom">Master Bathroom</option>
                            <option value="Balcony">Balcony</option>
                            <option value="Corridor">Corridor</option>
                            <option value="Entrance">Entrance</option>
                            <option value="Laundry">Laundry</option>
                            <option value="Storage">Storage</option>
                            <option value="Utility">Utility</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="defectType">
                            <option value="Unknown">Unknown</option>
                            <option value="Crack">Crack</option>
                            <option value="Water Damage">Water Damage</option>
                            <option value="Structural">Structural</option>
                            <option value="Finish">Finish</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Plumbing">Plumbing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Severity</label>
                        <select id="defectSeverity">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <div class="form-group mt-2">
                        <label>Add Photos</label>
                        <input type="file" id="defectImageInput" multiple accept="image/*" class="form-control"
                            style="background:#f8fafc; color:#1e293b; border:1px solid #e2e8f0; padding: 5px;">
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="defectDesc" readonly></textarea>
                    </div>
                    <div class="form-group">
                        <label>Coordinates</label>
                        <input type="text" id="defectCoords" readonly>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="defectStatus">
                            <option value="Reported">Reported</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Fixed">Fixed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="defectNotes" placeholder="Add notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveDefect()"><i class="fas fa-save"></i> Save
                        Changes</button>
                </div>
            </div>
        </div>

        <script>
            window.APP_CONFIG = {
                modelUrl: "{{ model_url | default('') }}",
                scanId: "{{ scan_id | default('') }}"
            };
        </script>
        <script src="{{ url_for('static', filename='module3/js/visualize.js') }}?v=2"></script>
    </main>
</body>

</html>