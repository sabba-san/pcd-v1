<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projects - LIDAR Defect Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');

    :root {
      --bg: #0b1020;
      --panel: rgba(255, 255, 255, 0.05);
      --ink: #e2e8f0;
      --muted: #94a3b8;
      --edge: rgba(255, 255, 255, 0.08);
      --accent: #7c3aed;
      --accent-2: #22d3ee;
    }

    body.light-mode {
      --bg: #f5f5f5;
      --panel: rgba(0, 0, 0, 0.04);
      --ink: #0f172a;
      --muted: #475569;
      --edge: rgba(0, 0, 0, 0.1);
      --accent: #7c3aed;
      --accent-2: #0ea5e9;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 1.5rem 1rem 3rem;
      font-family: 'Space Grotesk', 'Manrope', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.15), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(34, 211, 238, 0.12), transparent 30%),
                  linear-gradient(135deg, #0b1020 0%, #0f172a 45%, #0a101d 100%);
      color: var(--ink);
      min-height: 100vh;
    }

    body.light-mode {
      background: radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.08), transparent 30%),
                  linear-gradient(135deg, #f8fafc 0%, #e2e8f0 45%, #f5f5f5 100%);
    }

    .bento-grid { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; align-items: start; }
    .bento-card { position: relative; padding: 1.25rem 1.35rem; border-radius: 18px; background: linear-gradient(150deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02)); border: 1px solid var(--edge); box-shadow: 0 16px 36px rgba(0,0,0,0.35); overflow: hidden; }
    .bento-card::after { content: ''; position: absolute; inset: 0; background: radial-gradient(120% 120% at 100% 0%, rgba(124,58,237,0.12), transparent 60%); pointer-events: none; }
    body.light-mode .bento-card { background: linear-gradient(150deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); box-shadow: 0 16px 36px rgba(15,23,42,0.12); }
    body.light-mode .bento-card::after { background: radial-gradient(120% 120% at 100% 0%, rgba(124,58,237,0.08), transparent 60%); }
    .span-2 { grid-column: span 2; }
    @media (max-width: 960px) { .span-2 { grid-column: span 1; } }

    h1 { margin: 0; font-size: 2rem; display: flex; align-items: center; gap: 10px; color: var(--ink); }
    h1 i { color: var(--accent-2); }
    .subtitle { margin: 0.35rem 0 1rem; color: var(--muted); max-width: 780px; }
    .eyebrow { display: inline-flex; align-items: center; gap: 8px; padding: 0.35rem 0.75rem; border-radius: 999px; background: rgba(124,58,237,0.14); color: #c4b5fd; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; font-size: 0.8rem; }

    .theme-toggle { display: inline-flex; align-items: center; gap: 8px; padding: 0.45rem 0.9rem; border-radius: 999px; border: 1px solid var(--edge); background: rgba(255,255,255,0.08); color: var(--ink); font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
    .theme-toggle:hover { transform: translateY(-1px); border-color: rgba(124,58,237,0.45); box-shadow: 0 10px 18px rgba(0,0,0,0.25); }
    body.light-mode .theme-toggle { background: rgba(255,255,255,0.9); box-shadow: 0 10px 18px rgba(15,23,42,0.08); }

    .action-bar { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end; }
    .search-box { position: relative; width: 100%; flex: 1 1 260px; }
    .search-box input { width: 100%; padding: 0.75rem 0.9rem 0.75rem 2.75rem; border-radius: 12px; border: 1px solid var(--edge); background: rgba(255,255,255,0.04); color: var(--ink); font-size: 0.95rem; }
    .search-box i { position: absolute; left: 0.95rem; top: 50%; transform: translateY(-50%); color: var(--muted); }

    .filter-group { display: flex; flex-direction: column; gap: 0.35rem; flex: 0 0 200px; }
    .filter-label { font-size: 0.8rem; font-weight: 700; letter-spacing: 0.02em; color: var(--muted); text-transform: uppercase; }
    .filter-select { width: 100%; padding: 0.7rem 0.75rem; border-radius: 12px; border: 1px solid var(--edge); background: rgba(255,255,255,0.05); color: var(--ink); font-weight: 700; cursor: pointer; }
    body.light-mode .filter-select { background: rgba(255,255,255,0.92); box-shadow: 0 8px 18px rgba(15,23,42,0.08); }

    .btn { padding: 0.6rem 1.05rem; border-radius: 10px; border: 1px solid rgba(34,211,238,0.35); cursor: pointer; font-size: 0.95rem; font-weight: 700; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; background: linear-gradient(135deg, #22d3ee, #7c3aed); color: #0b1020; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(34,211,238,0.25); }

    .chip-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .chip { padding: 0.5rem 0.75rem; border-radius: 12px; border: 1px solid var(--edge); background: rgba(255,255,255,0.05); font-weight: 700; color: var(--ink); display: inline-flex; align-items: center; gap: 6px; }
    .chip i { color: var(--accent-2); }

    .projects-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }
    .project-card { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border: 1px solid var(--edge); border-radius: 14px; padding: 1.1rem; cursor: pointer; transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.2s ease; text-decoration: none; color: inherit; display: block; }
    .project-card:hover { transform: translateY(-3px); border-color: rgba(124,58,237,0.4); box-shadow: 0 12px 25px rgba(0,0,0,0.35); }
    body.light-mode .project-card { background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); box-shadow: 0 12px 24px rgba(15,23,42,0.12); }
    .project-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.9rem; }
    .project-title { font-size: 1.05rem; font-weight: 700; color: var(--ink); margin: 0; display: flex; align-items: center; gap: 8px; }
    .project-title i { color: var(--accent); }
    .project-id { font-size: 0.78rem; color: var(--ink); background: rgba(255,255,255,0.06); padding: 0.3rem 0.6rem; border-radius: 8px; border: 1px solid var(--edge); }

    .project-meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.65rem; margin-bottom: 0.85rem; }
    .meta-item { display: flex; flex-direction: column; gap: 0.15rem; }
    .meta-label { font-size: 0.75rem; text-transform: uppercase; color: var(--muted); font-weight: 700; letter-spacing: 0.02em; }
    .meta-value { font-size: 0.9rem; color: var(--ink); font-weight: 600; }

    .project-stats { display: flex; gap: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--edge); color: var(--muted); font-size: 0.9rem; }
    .stat { display: inline-flex; align-items: center; gap: 6px; }
    .stat i { color: var(--accent-2); }
    .stat-value { font-weight: 700; color: var(--ink); }

    .empty-state { text-align: center; padding: 3.5rem 2rem; color: var(--muted); border: 1px dashed var(--edge); background: rgba(255,255,255,0.02); border-radius: 14px; }
    .empty-state i { font-size: 3rem; color: rgba(255,255,255,0.35); margin-bottom: 1rem; }
    .empty-state h3 { font-size: 1.2rem; color: var(--ink); margin-bottom: 0.5rem; }
    .empty-state p { margin-bottom: 1.5rem; }
  </style>
</head>
<body>
  {% set total_projects = projects|length %}
  {% set total_defects = projects|sum(attribute='defect_count') %}
  <main class="bento-grid">
    <section class="bento-card span-2">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.65rem; gap: 0.75rem; flex-wrap: wrap;">
        <span class="eyebrow"><i class="fas fa-bolt"></i> Portfolio</span>
        <div class="chip-row">
          <span class="chip"><i class="fas fa-folder-open"></i> {{ total_projects }} projects</span>
          <span class="chip"><i class="fas fa-exclamation-triangle"></i> {{ total_defects }} defects</span>
        </div>
        <button id="themeToggle" class="theme-toggle" type="button">
          <i class="fas fa-moon"></i>
          <span>Dark</span>
        </button>
      </div>
      <h1><i class="fas fa-folder-open"></i> Projects</h1>
      <p class="subtitle">Select a project to view and manage defects in the 3D visualization viewer.</p>
      <div class="action-bar">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search projects..." onkeyup="filterProjects()">
        </div>
        <div class="filter-group">
          <label class="filter-label" for="dateFilter">Date range</label>
          <select id="dateFilter" class="filter-select" onchange="filterProjects()">
            <option value="all">All time</option>
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label" for="sortOrder">Sort</label>
          <select id="sortOrder" class="filter-select" onchange="filterProjects()">
            <option value="newest">Newest to oldest</option>
            <option value="oldest">Oldest to newest</option>
          </select>
        </div>
        <a href="/upload-data" class="btn"><i class="fas fa-plus"></i> New Project</a>
      </div>
    </section>

    {% if projects %}
    <section class="bento-card span-2">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h2 style="margin: 0; color: var(--ink);">Project List</h2>
        <span class="chip" style="color: var(--muted); background: rgba(255,255,255,0.05);">{{ total_projects }} items</span>
      </div>
      <div class="projects-grid" id="projectsGrid">
        {% for project in projects %}
        <a href="/scans/{{ project.id }}/visualize" class="project-card" data-name="{{ project.name|lower }}" data-date="{{ project.created_at.isoformat() if project.created_at else '' }}">
          <div class="project-header">
            <h3 class="project-title">
              <i class="fas fa-cube"></i>
              {{ project.name }}
            </h3>
            <span class="project-id">#{{ project.id }}</span>
          </div>

          <div class="project-meta">
            {% if project.metadata %}
            <div class="meta-item">
              <div class="meta-label">Scan Date</div>
              <div class="meta-value">{{ project.metadata.scan_date or 'N/A' }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">Unit</div>
              <div class="meta-value">{{ project.metadata.unit_no or 'N/A' }}</div>
            </div>
            {% if project.metadata.address %}
            <div class="meta-item" style="grid-column: span 2;">
              <div class="meta-label">Address</div>
              <div class="meta-value" style="font-size: 0.85rem;">{{ project.metadata.address }}</div>
            </div>
            {% endif %}
            {% else %}
            <div class="meta-item">
              <div class="meta-label">Created</div>
              <div class="meta-value">{{ project.created_at.strftime('%Y-%m-%d') }}</div>
            </div>
            {% endif %}
          </div>

          <div class="project-stats">
            <div class="stat">
              <i class="fas fa-exclamation-triangle"></i>
              <span class="stat-value">{{ project.defect_count }}</span> defects
            </div>
            {% if project.model_path %}
            <div class="stat">
              <i class="fas fa-cube"></i>
              <span>3D Model</span>
            </div>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </div>
    </section>
    {% else %}
    <section class="bento-card span-2 empty-state">
      <i class="fas fa-folder-open"></i>
      <h3>No Projects Yet</h3>
      <p>Upload your first scan to get started with defect detection and visualization.</p>
      <a href="/upload-data" class="btn">
        <i class="fas fa-upload"></i> Upload First Scan
      </a>
    </section>
    {% endif %}
  </main>

  <script>
    function applyTheme(theme) {
      const body = document.body;
      const toggle = document.getElementById('themeToggle');
      const icon = toggle.querySelector('i');
      const label = toggle.querySelector('span');

      if (theme === 'light') {
        body.classList.add('light-mode');
        icon.className = 'fas fa-sun';
        label.textContent = 'Light';
      } else {
        body.classList.remove('light-mode');
        icon.className = 'fas fa-moon';
        label.textContent = 'Dark';
        theme = 'dark';
      }

      localStorage.setItem('projects-theme', theme);
    }

    function toggleTheme() {
      const current = localStorage.getItem('projects-theme') || 'dark';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    }

    document.addEventListener('DOMContentLoaded', () => {
      applyTheme(localStorage.getItem('projects-theme') || 'dark');
      const toggle = document.getElementById('themeToggle');
      if (toggle) {
        toggle.addEventListener('click', toggleTheme);
      }
    });

    function filterProjects() {
      const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
      const dateRange = document.getElementById('dateFilter')?.value || 'all';
      const sortOrder = document.getElementById('sortOrder')?.value || 'newest';
      const grid = document.getElementById('projectsGrid');
      const cards = Array.from(document.querySelectorAll('.project-card'));

      const now = new Date();
      const rangeDays = dateRange === 'all' ? null : parseInt(dateRange, 10);

      const filtered = cards.filter(card => {
        const name = card.getAttribute('data-name') || '';
        if (!name.includes(searchTerm)) return false;

        if (!rangeDays) return true;

        const dateStr = card.getAttribute('data-date');
        const projectDate = dateStr ? new Date(dateStr) : null;
        if (!projectDate || isNaN(projectDate)) return true;

        const diffDays = (now - projectDate) / (1000 * 60 * 60 * 24);
        return diffDays <= rangeDays;
      });

      const timeValue = card => {
        const dateStr = card.getAttribute('data-date');
        const dt = dateStr ? new Date(dateStr) : null;
        return dt && !isNaN(dt) ? dt.getTime() : 0;
      };

      filtered.sort((a, b) => {
        const diff = timeValue(b) - timeValue(a);
        return sortOrder === 'oldest' ? -diff : diff;
      });

      cards.forEach(card => { card.style.display = 'none'; });
      filtered.forEach(card => { card.style.display = 'block'; grid.appendChild(card); });
    }
  </script>
</body>
</html>
